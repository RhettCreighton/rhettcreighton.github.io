{"version":3,"names":[],"mappings":"","sources":["xiangqi-model.js"],"sourcesContent":["\n(function() {\n\t\n\tvar geometry = Model.Game.cbBoardGeometryGrid(9,10);\n\tgeometry.ADVISOR_AREA = {3:1,5:1,13:1,21:1,23:1,66:1,68:1,76:1,84:1,86:1};\n\tgeometry.ELEPHANT_AREA = { \n\t\t'1': {2:1,6:1,18:1,22:1,26:1,38:1,42:1}, \n\t\t'-1': {83:1,87:1,63:1,67:1,71:1,47:1,51:1},\n\t};\n\tgeometry.GENERAL_AREA = { \n\t\t3:1, 4:1, 5:1,12:1,13:1,14:1,21:1,22:1,23:1,\n\t\t84:1,85:1,86:1,75:1,76:1,77:1,66:1,67:1,68:1\n\t};\n\t// TODO move params below into variant definition\n\tModel.Game.cbOnPerpetual = 1; // 3 times state repeat = repeater loses\n\tModel.Game.cbOnStaleMate = 1; // stalemate = last player loses\n\n\t\n\tModel.Game.cbDefine = function() {\n\t\t\n\t\treturn {\n\t\t\t\n\t\t\tgeometry: geometry,\n\t\t\t\n\t\t\tpieceTypes: {\n\n\t\t\t\t0: {\n\t\t\t\t\tname: 'pawn-w',\n\t\t\t\t\taspect: 'xq-pawn',\n\t\t\t\t\tgraph: this.cbXQPromoSoldierGraph(geometry,1),\n\t\t\t\t\tabbrev: '',\n\t\t\t\t\tvalue: 2,\n\t\t\t\t\tfenAbbrev: 'P',\n\t\t\t\t},\n\t\t\t\t\n\t\t\t\t1: {\n\t\t\t\t\tname: 'pawn-b',\n\t\t\t\t\taspect: 'xq-pawn',\n\t\t\t\t\tgraph: this.cbXQPromoSoldierGraph(geometry,-1),\n\t\t\t\t\tabbrev: '',\n\t\t\t\t\tvalue: 2,\n\t\t\t\t\tfenAbbrev: 'P',\n\t\t\t\t},\n\n\t\t\t\t2: {\n\t\t\t\t\tname: 'ipawn-w',\n\t\t\t\t\taspect: 'xq-pawn',\n\t\t\t\t\tgraph: this.cbXQSoldierGraph(geometry,1),\n\t\t\t\t\tabbrev: '',\n\t\t\t\t\tvalue: 1,\n\t\t\t\t\tfenAbbrev: 'P',\n\t\t\t\t\tinitial: [{s:1,p:27},{s:1,p:29},{s:1,p:31},{s:1,p:33},{s:1,p:35}],\n\t\t\t\t},\n\n\t\t\t\t3: {\n\t\t\t\t\tname: 'ipawn-b',\n\t\t\t\t\taspect: 'xq-pawn',\n\t\t\t\t\tgraph: this.cbXQSoldierGraph(geometry,-1),\n\t\t\t\t\tabbrev: '',\n\t\t\t\t\tvalue: 1,\n\t\t\t\t\tfenAbbrev: 'P',\n\t\t\t\t\tinitial: [{s:-1,p:54},{s:-1,p:56},{s:-1,p:58},{s:-1,p:60},{s:-1,p:62}],\n\t\t\t\t},\n\t\t\t\t\n\t\t\t\t4: {\n\t\t\t\t\tname: 'cannon',\n\t\t\t\t\taspect: 'xq-cannon',\n\t\t\t\t\tgraph: this.cbXQCannonGraph(geometry),\n\t\t\t\t\tabbrev: 'C',\n\t\t\t\t\tvalue: 4.5,\n\t\t\t\t\tinitial: [{s:1,p:19},{s:1,p:25},{s:-1,p:64},{s:-1,p:70}],\n\t\t\t\t},\n\t\t\t\t\n\t\t\t\t5: {\n\t\t\t\t\tname: 'chariot',\n\t\t\t\t\taspect: 'xq-chariot',\n\t\t\t\t\tgraph: this.cbRookGraph(geometry),\n\t\t\t\t\tabbrev: 'R',\n\t\t\t\t\tvalue: 9,\n\t\t\t\t\tinitial: [{s:1,p:0},{s:1,p:8},{s:-1,p:81},{s:-1,p:89}],\n\t\t\t\t},\n\n\t\t\t\t6: {\n\t\t\t\t\tname: 'horse',\n\t\t\t\t\taspect: 'xq-horse',\n\t\t\t\t\tgraph: this.cbHorseGraph(geometry),\n\t\t\t\t\tabbrev: 'H',\n\t\t\t\t\tvalue: 4,\n\t\t\t\t\tinitial: [{s:1,p:1},{s:1,p:7},{s:-1,p:82},{s:-1,p:88}],\n\t\t\t\t},\n\n\t\t\t\t7: {\n\t\t\t\t\tname: 'elephant-w',\n\t\t\t\t\taspect: 'xq-elephant',\n\t\t\t\t\tgraph: this.cbXQElephantGraph(geometry,geometry.ELEPHANT_AREA[1]),\n\t\t\t\t\tabbrev: 'E',\n\t\t\t\t\tvalue: 2,\n\t\t\t\t\tinitial: [{s:1,p:2},{s:1,p:6}],\n\t\t\t\t},\n\t\t\t\t\n\t\t\t\t8: {\n\t\t\t\t\tname: 'elephant-b',\n\t\t\t\t\taspect: 'xq-elephant',\n\t\t\t\t\tgraph: this.cbXQElephantGraph(geometry,geometry.ELEPHANT_AREA[-1]),\n\t\t\t\t\tabbrev: 'E',\n\t\t\t\t\tvalue: 2,\n\t\t\t\t\tinitial: [{s:-1,p:83},{s:-1,p:87}],\n\t\t\t\t},\n\t\t\t\t\n\t\t\t\t9: {\n\t\t\t\t\tname: 'advisor',\n\t\t\t\t\taspect: 'xq-advisor',\n\t\t\t\t\tgraph: this.cbXQAdvisorGraph(geometry,geometry.ADVISOR_AREA),\n\t\t\t\t\tabbrev: 'A',\n\t\t\t\t\tvalue: 2,\n\t\t\t\t\tinitial: [{s:1,p:3},{s:1,p:5},{s:-1,p:84},{s:-1,p:86}],\n\t\t\t\t},\n\t\t\t\t\n\t\t\t\t10: {\n\t\t\t\t\tname: 'general',\n\t\t\t\t\taspect: 'xq-general',\n\t\t\t\t\tisKing: true,\n\t\t\t\t\tgraph: this.cbXQGeneralGraph(geometry,geometry.GENERAL_AREA),\n\t\t\t\t\tabbrev: 'K',\n\t\t\t\t\tinitial: [{s:1,p:4},{s:-1,p:85}],\n\t\t\t\t},\n\t\t\t\t\n\t\t\t},\n\t\t\t\n\t\t\tpromote: function(aGame,piece,move) {\n\t\t\t\tif(piece.t==2 && move.t>=45)\n\t\t\t\t\treturn [0];\n\t\t\t\telse if(piece.t==3 && move.t<45)\n\t\t\t\t\treturn [1];\n\t\t\t\treturn [];\n\t\t\t\treturn [];\n\t\t\t},\n\n\t\t\t/*\n\t\t\timportGame: function(initial,format,data) {\n\t\t\t\tinitial.pieces.forEach(function(piece) {\n\t\t\t\t\tif(piece.s==1 && geometry.R(piece.p)==1 && piece.t==0) {\n\t\t\t\t\t\tpiece.t=1;\n\t\t\t\t\t\tpiece.m=false;\n\t\t\t\t\t}\n\t\t\t\t\tif(piece.s==1 && geometry.R(piece.p)!=1 && piece.t==1) {\n\t\t\t\t\t\tpiece.t=0;\n\t\t\t\t\t\tpiece.m=true;\n\t\t\t\t\t}\n\t\t\t\t\tif(piece.s==-1 && geometry.R(piece.p)==geometry.height-2 && piece.t==2) {\n\t\t\t\t\t\tpiece.t=3;\n\t\t\t\t\t\tpiece.m=false;\n\t\t\t\t\t}\n\t\t\t\t\tif(piece.s==-1 && geometry.R(piece.p)!=geometry.height-2 && piece.t==3) {\n\t\t\t\t\t\tpiece.t=2;\n\t\t\t\t\t\tpiece.m=true;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\t*/\n\t\t};\n\t}\n\n\tModel.Board.CompactMoveString = function(aGame,aMove) {\n\t\tvar $this=this;\n\t\tfunction ColName(col) {\n\t\t\tif($this.mWho>0)\n\t\t\t\treturn 9-col;\n\t\t\telse\n\t\t\t\treturn col+1;\n\t\t}\n\t\tvar letters={0:'P',1:'P',2:'P',3:'P',4:'C',5:'R',6:'H',7:'E',8:'E',9:'A',10:'K'};\n\t\tfunction GetNotation(aMove) {\n\t\t\tvar piece=$this.pieces[$this.board[aMove.f]];\n\t\t\tvar letter=letters[piece.t];\n\t\t\tvar str=letter;\n\t\t\tvar startCol=geometry.C(aMove.f);\n\t\t\tvar endCol=geometry.C(aMove.t);\n\t\t\tvar startRow=geometry.R(aMove.f);\n\t\t\tvar endRow=geometry.R(aMove.t);\n\t\t\tvar matching=[];\n\t\t\t$this.pieces.forEach(function(piece) {\n\t\t\t\tif(piece.p>=0 && piece.s==$this.mWho && letters[piece.t]==letter && geometry.C(piece.p)==startCol)\n\t\t\t\t\tmatching.push(piece);\n\t\t\t});\n\t\t\tmatching.sort(function(a,b) {\n\t\t\t\treturn (geometry.R(a.p)-geometry.R(b.p))*$this.mWho;\n\t\t\t});\n\t\t\tif(matching.length==1)\n\t\t\t\tstr+=ColName(startCol);\n\t\t\telse if(matching.length==2) {\n\t\t\t\tif(matching[0]==piece)\n\t\t\t\t\tstr+='+';\n\t\t\t\telse\n\t\t\t\t\tstr+='-';\n\t\t\t} else if(matching.length==3) {\n\t\t\t\tif(matching[0]==piece)\n\t\t\t\t\tstr+='+';\n\t\t\t\telse if(matching[1]==piece)\n\t\t\t\t\tstr+=ColName(startCol);\n\t\t\t\telse\n\t\t\t\t\tstr+='-';\n\t\t\t} else if(matching.length==4) {\n\t\t\t\tif(matching[0]==piece)\n\t\t\t\t\tstr='++';\n\t\t\t\telse if(matching[1]==piece)\n\t\t\t\t\tstr+='+';\n\t\t\t\telse if(matching[2]==piece)\n\t\t\t\t\tstr+='-';\n\t\t\t\telse\n\t\t\t\t\tstr='--';\n\t\t\t} else if(matching.length==5) {\n\t\t\t\tif(matching[0]==piece)\n\t\t\t\t\tstr='++';\n\t\t\t\telse if(matching[1]==piece)\n\t\t\t\t\tstr+='+';\n\t\t\t\telse if(matching[2]==piece)\n\t\t\t\t\tstr+=ColName(startCol);\n\t\t\t\telse if(matching[3]==piece)\n\t\t\t\t\tstr+='-';\n\t\t\t\telse\n\t\t\t\t\tstr='--';\n\t\t\t}\n\t\t\t\n\t\t\tif(startRow==endRow)\n\t\t\t\tstr+='.'+ColName(endCol);\n\t\t\telse {\n\t\t\t\tif((endRow-startRow)*$this.mWho>0)\n\t\t\t\t\tstr+='+';\n\t\t\t\telse\n\t\t\t\t\tstr+='-';\n\t\t\t\tif(startCol!=endCol)\n\t\t\t\t\tstr+=ColName(endCol);\n\t\t\t\telse if((endRow-startRow)*$this.mWho>0)\n\t\t\t\t\tstr+=Math.abs(endRow-startRow);\n\t\t\t\telse \n\t\t\t\t\tstr+=Math.abs(endRow-startRow);\n\t\t\t}\n\t\t\t\n\t\t\treturn str;\n\t\t}\n\n\t\tvar moveStr0=GetNotation(aMove);\n\t\t\n\t\tvar piece=this.pieces[this.board[aMove.f]];\n\t\tif(letters[piece.t]=='P' && geometry.R(aMove.f)==geometry.R(aMove.t)) {\n\t\t\tvar tandemCols={};\n\t\t\tthis.pieces.forEach(function(piece) {\n\t\t\t\tif(piece.p>=0 && piece.s==$this.mWho && letters[piece.t]=='P') {\n\t\t\t\t\tvar startCol=geometry.C(piece.p);\n\t\t\t\t\tif(tandemCols[startCol]===undefined)\n\t\t\t\t\t\ttandemCols[startCol]=1;\n\t\t\t\t\telse\n\t\t\t\t\t\ttandemCols[startCol]++;\n\t\t\t\t}\n\t\t\t});\n\t\t\tvar tandemCount=0;\n\t\t\tfor(var col in tandemCols)\n\t\t\t\tif(tandemCols[col]>1)\n\t\t\t\t\ttandemCount++;\n\t\t\tif(tandemCount>1) {\n\t\t\t\tmoveStr0=ColName(geometry.C(aMove.f))+moveStr0.substr(1);\n\t\t\t}\n\t\t}\n\n\t\treturn moveStr0;\n\t}\n\n\tModel.Move.ToString = function(format) {\n\t\tvar self = this;\n\t\tfunction PosName(pos) {\n\t\t\tvar col = pos % 9;\n\t\t\tvar row = (pos-col)/9;\n\t\t\treturn String.fromCharCode((\"a\".charCodeAt(0))+col) + row;\n\t\t}\n\t\treturn PosName(self.f) + PosName(self.t);\n\t}\n\t\n})();"],"file":"xiangqi-model.js"}