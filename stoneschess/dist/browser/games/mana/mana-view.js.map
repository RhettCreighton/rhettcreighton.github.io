{"version":3,"names":[],"mappings":"","sources":["mana-xd-view.js"],"sourcesContent":["/*\n *\n * Copyright (c) 2013 - Jocly - www.jocly.com\n * \n * This file is part of the Jocly game platform and cannot be used outside of this context without the written permission of Jocly.\n * \n */\n\n(function() {\n\t\n\tvar VSIZE=1500;\n\t\n\tView.Game.xdInit = function(xdv) {\n\n\n\t\tvar fullPath=this.mViewOptions.fullPath ;\n\t\tvar options=this.mOptions;\n\t\t\n\t\txdv.createGadget(\"lightside\", {\n\t\t\t\"3d\": {\n\t\t\t\ttype: \"custom3d\",\n\t\t\t\tcreate: function() {\n\t\t\t\t\tvar backlight = new THREE.SpotLight( 0xbbbbbb, .6, 0, 1.05, 1, 2 );\n\t\t\t\t\tbacklight.shadow.camera.near=10;\n\t\t\t\t\tbacklight.shadow.camera.far=40;\n\t\t\t\t\tbacklight.castShadow = true;\n\t\t\t\t\tbacklight.shadow.mapSize.width = 2048;\n\t\t\t\t\tbacklight.shadow.mapSize.height = 2048;\n\t\t\t\t\treturn backlight;\n\t\t\t\t},\n\t\t\t\tz: 15000,\n\t\t\t\tx: 15000,\n\t\t\t}\n\t\t});\n\t\t\n\t\t\n\t\txdv.createGadget(\"board\", {\n\t\t\t\"2d\": {\n\t\t\t\ttype : \"image\",\n\t\t\t\tfile : this.mViewOptions.fullPath + \"/res/images/boardexp.png\",\n\t\t\t\trotate : 45,\n\t\t\t\twidth: VSIZE*this.mOptions.width/.75,\n\t\t\t\theight: VSIZE*this.mOptions.height/.75,\n\t\t\t},\n\t\t\t\"orange3d\" : {\n\t\t\t\ttype : \"custommesh3d\",\n\t\t\t\trotate : 45,\t\n\t\t\t\tz:0,\n\t\t\t\tcreate: function() {\n\t\t\t\t\tvar $this=this;\n\t\t\t\t\tvar gg=new THREE.CylinderGeometry(500,500,1, 64, 1, false);\t\t\n\t\t\t\t\tvar gm=new THREE.MeshPhongMaterial( { color: 0xDAA037, specular: 0x111111, shininess: 1 } );\n\t\t\t\t\t//var gm=new THREE.MeshPhongMaterial( { color: 0xff0000 } );\n\t\t\t\t\tvar board = new THREE.Mesh( gg , gm );\n\t\t\t\t\tthis.getResource(\"smoothedfilegeo|\"+0+\"|\"+fullPath+\"/res/xd-view/meshes/strokeblack.js\",function(geometry , materials) {\n\t\t\t\t\t\tvar gm=new THREE.MeshPhongMaterial( { color: 0x111111, specular: 0x000000, shininess: 100 } );\n\t\t\t\t\t\tvar VSIZE=1.5; // local redefinition\n\t\t\t\t\t\tfor (var r = 0 ; r < options.height ; r++){\n\t\t\t\t\t\t\tfor (var c = 0 ; c < options.width ; c++){\n\t\t\t\t\t\t\t\tvar y=-(options.width*VSIZE)/2+c*VSIZE+VSIZE/2;\n\t\t\t\t\t\t\t\tvar x=(options.height*VSIZE)/2-r*VSIZE-VSIZE/2;\n\t\t\t\t\t\t\t\tvar nb=options.initial[r][c];\n\t\t\t\t\t\t\t\tvar strokeInterval=0;\n\n\t\t\t\t\t\t\t\tswitch(nb){\n\t\t\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\tcase \"2\":\n\t\t\t\t\t\t\t\t\tstrokeInterval=VSIZE/4;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\tcase \"3\":\n\t\t\t\t\t\t\t\t\tstrokeInterval=VSIZE/6;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\n\t\t\t\t\t\t\t\tvar delta=(nb-1)*strokeInterval/2;\n\t\t\t\t\t\t\t\tfor (var s=0 ; s < options.initial[r][c] ; s++){\n\t\t\t\t\t\t\t\t\tfor (var i=0 ; i < 2 ; i++){\n\t\t\t\t\t\t\t\t\t\tvar obj = new THREE.Mesh( geometry , gm );\n\t\t\t\t\t\t\t\t\t\tobj.position.y=0.5;\n\t\t\t\t\t\t\t\t\t\tobj.position.x=(i>0)?x:x-delta+s*strokeInterval;\n\t\t\t\t\t\t\t\t\t\tobj.position.z=(i<1)?y:y-delta+s*strokeInterval;\n\t\t\t\t\t\t\t\t\t\tobj.rotation.y=Math.ceil(Math.random()*2)*Math.PI + i*Math.PI/2;\n\t\t\t\t\t\t\t\t\t\tobj.scale.set(0.3,0.5,0.5);\n\t\t\t\t\t\t\t\t\t\t//obj.castShadow=true;\n\t\t\t\t\t\t\t\t\t\t//obj.receiveShadow=true;\n\t\t\t\t\t\t\t\t\t\tboard.add(obj);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tboard.receiveShadow=true;\n\t\t\t\t\t\t$this.objectReady(board);\n\t\t\t\t\t});\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t\t\n\t\tvar manaCreateScreen = function(videoTexture) {\n\t\t\t// flat screens\n\t\t\tvar gg=new THREE.PlaneGeometry(4,3,1,1);\n\t\t\tvar gm=new THREE.MeshPhongMaterial({color:0xffffff,map:videoTexture,shading:THREE.FlatShading,emissive:{r:1,g:1,b:1}});\n\t\t\tvar mesh = new THREE.Mesh( gg , gm );\n\t\t\tthis.objectReady(mesh); \n\t\t\treturn null;\n\t\t}\t\t\n\t\t\n\t\txdv.createGadget(\"videoa\",{\n\t\t\t\"3d\": {\n\t\t\t\ttype : \"video3d\",\t\t\t\t\n\t\t\t\tmakeMesh: function(videoTexture){\n\t\t\t\t\treturn manaCreateScreen.call(this,videoTexture);\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t\txdv.createGadget(\"videoabis\",{\n\t\t\t\"3d\": {\n\t\t\t\ttype : \"video3d\",\t\t\t\t\n\t\t\t\tmakeMesh: function(videoTexture){\n\t\t\t\t\treturn manaCreateScreen.call(this,videoTexture);\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t\txdv.createGadget(\"videob\",{\n\t\t\t\"3d\": {\n\t\t\t\ttype : \"video3d\",\t\t\t\t\n\t\t\t\tmakeMesh: function(videoTexture){\n\t\t\t\t\treturn manaCreateScreen.call(this,videoTexture);\n\t\t\t\t},\n\t\t\t},\n\t\t});\t\n\t\txdv.createGadget(\"videobbis\",{\n\t\t\t\"3d\": {\n\t\t\t\ttype : \"video3d\",\t\t\t\t\n\t\t\t\tmakeMesh: function(videoTexture){\n\t\t\t\t\treturn manaCreateScreen.call(this,videoTexture);\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t\t\n\t\tvar orients=[{\n\t\t\ttext: \"NW\",\n\t\t\tclassic2d: {\n\t\t\t\tx: -VSIZE*2.5,\n\t\t\t\ty: -VSIZE*2.5,\n\t\t\t},\n\t\t\torange3d:{\n\t\t\t\tx: -VSIZE*2.5,\n\t\t\t\ty: -VSIZE*2.5,\n\t\t\t\trotate: -45,\n\t\t\t\tcolor:0x000000,\n\t\t\t},\n\t\t},{\n\t\t\ttext: \"NE\",\n\t\t\tclassic2d:{\n\t\t\t\tx: VSIZE*2.5,\n\t\t\t\ty: -VSIZE*2.5,\n\t\t\t},\n\t\t\torange3d:{\n\t\t\t\tx: VSIZE*2.5,\n\t\t\t\ty: -VSIZE*2.5,\t\t\n\t\t\t\trotate: 225,\t\n\t\t\t\tcolor:0x000000,\n\t\t\t},\n\t\t},{\n\t\t\ttext: \"SW\",\n\t\t\tclassic2d:{\n\t\t\t\tx: -VSIZE*2.5,\n\t\t\t\ty: VSIZE*2.5,\n\t\t\t},\n\t\t\torange3d:{\n\t\t\t\tx: -VSIZE*2.5,\n\t\t\t\ty: VSIZE*2.5,\t\t\t\n\t\t\t\trotate: 45,\n\t\t\t\tcolor:0x000000,\n\t\t\t},\n\t\t},{\n\t\t\ttext: \"SE\",\n\t\t\tclassic2d:{\n\t\t\t\tx: VSIZE*2.5,\n\t\t\t\ty: VSIZE*2.5,\n\t\t\t},\n\t\t\torange3d: {\n\t\t\t\tx: VSIZE*2.5,\n\t\t\t\ty: VSIZE*2.5,\n\t\t\t\trotate: 135,\n\t\t\t\tcolor:0x000000,\n\t\t\t},\t\n\t\t}];\n\t\tvar fullPath=this.mViewOptions.fullPath;\n\t\tfor(var i=0; i<orients.length; i++) {\n\t\t\tvar orient=orients[i];\n\t\t\t(function(orient) {\n\t\t\t\txdv.createGadget(\"orient#\"+orient.text,{\n\t\t\t\t\t\"2d\": {\n\t\t\t\t\t\ttype : \"element\",\n\t\t\t\t\t\twidth : VSIZE*.9,\n\t\t\t\t\t\theight : VSIZE*.9,\n\t\t\t\t\t\tcss : {\n\t\t\t\t\t\t\tcolor : \"Black\",\n\t\t\t\t\t\t\t\"text-align\" : \"center\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\tinitialClasses: \"mana-select mana-select-view\",\n\t\t\t\t\t\tx : orient.classic2d.x,\n\t\t\t\t\t\ty : orient.classic2d.y,\n\t\t\t\t\t\tz : 4,\n\t\t\t\t\t\tdisplay : function(element, width, height) {\n\t\t\t\t\t\t\telement.css({\n\t\t\t\t\t\t\t\t\"font-size\" : (height * .3) + \"pt\",\n\t\t\t\t\t\t\t\t\"line-height\" : (height * 1) + \"px\",\n\t\t\t\t\t\t\t}).text(orient.text);\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t\"orange3d\" : {\n\t\t\t\t\t\ttype: \"meshfile\",\n\t\t\t\t\t\tfile: fullPath + \"/res/xd-view/meshes/select-smoothed.js\",\n\t\t\t\t\t\tscale: [1,1,1],\n\t\t\t\t\t\tsmooth: 0,\n\t\t\t\t\t\tx : orient.orange3d.x,\n\t\t\t\t\t\ty : orient.orange3d.y,\n\t\t\t\t\t\trotate: orient.orange3d.rotate-90,\n\t\t\t\t\t\tmaterials: { \n\t\t\t\t\t\t\t\"square\" : {\n\t\t\t\t\t\t\t\ttransparent: true,\n\t\t\t\t\t\t\t\topacity: 0,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"mat.arrow\" : {\n\t\t\t\t\t\t\t\tcolor : orient.orange3d.color,\n\t\t\t\t\t\t\t\tshininess : 255,\n\t\t\t\t\t\t\t}, \n\t\t\t\t\t\t\t\"ring\" : {\n\t\t\t\t\t\t\t\tshininess:10,\n\t\t\t\t\t\t\t\temissive:{r:.6,g:.6,b:.6},\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t}, \n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t})(orient);\n\t\t}\n\n\t\tfor(var pos=0;pos<this.g.Graph.length;pos++)\n\t\t\t(function(pos) {\n\t\t\t\txdv.createGadget(\"text#\"+pos,{\n\t\t\t\t\t\"2d\": {\n\t\t\t\t\t\ttype : \"element\",\n\t\t\t\t\t\twidth : VSIZE*.20,\n\t\t\t\t\t\theight : VSIZE*.20,\n\t\t\t\t\t\tinitialClasses: \"mana-text\",\n\t\t\t\t\t\tz : 4,\n\t\t\t\t\t\tdisplay : function(element, width, height) {\n\t\t\t\t\t\t\telement.css({\n\t\t\t\t\t\t\t\t\"font-size\" : (height * .5) + \"pt\",\n\t\t\t\t\t\t\t\t\"line-height\" : (height * 1) + \"px\",\n\t\t\t\t\t\t\t}).text(pos);\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t\"orange3d\": {\n\t\t\t\t\t\ttype: \"custommesh3d\",\n\t\t\t\t\t\t//z: -SIZE*.05,\n\t\t\t\t\t\trotateX: -90,\n\t\t\t\t\t\tcreate: function() {\n                            var $this = this;\n                            this.getResource('font|'+fullPath+\n                                '/res/xd-view/fonts/helvetiker_regular.typeface.json',\n                                function(font) {\n                                var gg=new THREE.TextGeometry(\"\"+pos,{\n                                    size: 0.2,\n                                    height: 0.05,\n                                    curveSegments: 6,\n                                    font: font,\n\n                                });\n                                var gm=new THREE.MeshPhongMaterial( { color: 0xff0000 } );\n                                var mesh= new THREE.Mesh( gg , gm );\n                                $this.objectReady(mesh);\n                            });\n\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t});\t\t\t\t\n\t\t\t\txdv.createGadget(\"cell#\"+pos,{\n\t\t\t\t\t\"2d\": {\n\t\t\t\t\t\ttype : \"element\",\n\t\t\t\t\t\twidth : VSIZE*1.05,\n\t\t\t\t\t\theight : VSIZE*1.05,\n\t\t\t\t\t\tinitialClasses: \"mana-select\",\n\t\t\t\t\t\tz : 5,\n\t\t\t\t\t},\n\t\t\t\t\t\"orange3d\": {\n\t\t\t\t\t\ttype: \"meshfile\",\n\t\t\t\t\t\tfile : fullPath+\"/res/xd-view/meshes/select-smoothed.js\",\n\t\t\t\t\t\tscale: [.9,.9,.9],\n\t\t\t\t\t\tsmooth : 0,\n\t\t\t\t\t\tz : 0,\t\t\n\t\t\t\t\t\tcastShadow: false,\n\t\t\t\t\t\tmaterials: { \n\t\t\t\t\t\t\t\"square\" : {\n\t\t\t\t\t\t\t\ttransparent: true,\n\t\t\t\t\t\t\t\topacity: 0,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"mat.arrow\" : {\n\t\t\t\t\t\t\t\ttransparent: true,\n\t\t\t\t\t\t\t\topacity: 0,\n\t\t\t\t\t\t\t}, \n\t\t\t\t\t\t\t\"ring\" : {\n\t\t\t\t\t\t\t\tshininess:10,\n\t\t\t\t\t\t\t\temissive:{r:.6,g:.6,b:.6},\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\t\n\t\t\t\t\t},\n\t\t\t\t});\t\t\t\t\n\t\t\t})(pos);\n\t\t\n\t\tfunction createPawn(avatar,callback,type,who){\n\t\t\tvar url=\"smoothedfilegeo|\"+0+\"|\"+fullPath+\"/res/xd-view/meshes/mana-piece-smoothed2.js\";\n\t\t\tavatar.getResource(url,function(geometry , materials){\n\t\t\t \tvar materials0=[];\n\t\t\t\tfor(var m=0;m<materials.length;m++){\n\t\t\t\t\tvar mat=materials[m].clone();\n\t\t\t\t\tmat.specular={r:.1,g:.1,b:.1};\n\t\t\t\t\t//mat.ambient={r:.1,g:.1,b:.1};\n\t\t\t\t\tmat.shininess=10;\n\t\t\t\t\tif (who==-1){\t\t\t\t\t\t\n\t\t\t\t\t\tmat.color={r:.5,g:.2,b:0};\n\t\t\t\t\t\tif ((mat.name==\"blackstripe\")&&(type==\"damyo\")){\n\t\t\t\t\t\t\tmat.color={r:1,g:.8,b:.8};\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\tmat.color={r:1,g:1,b:1};\t\t\t\t\t\t\n\t\t\t\t\t\tif ((mat.name==\"blackstripe\")&&(type==\"damyo\")){\n\t\t\t\t\t\t\tmat.color={r:0,g:0,b:0};\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tmaterials0.push(mat);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tvar pawn = new THREE.Mesh(geometry, new THREE.MultiMaterial(materials0));\n\t\t\t\tpawn.castShadow=true;\n\t\t\t\tcallback(pawn);\n\t\t\t});\n\t\t}\n\t\t\n\t\tvar pieceClipW=150;\n\t\tfor(var who=1;who>=-1;who-=2) {\n\t\t\tfor(var i=0;i<this.mOptions.damyoCount;i++)\n\t\t\t\t(function(who,i){\n\t\t\t\t\txdv.createGadget(\"damyo#\"+who+\"#\"+i,{\n\t\t\t\t\t\t\"2d\": {\n\t\t\t\t\t\t\ttype: \"sprite\",\n\t\t\t\t\t\t\tfile : fullPath + \"/res/images/manapieces.png\",\n\t\t\t\t\t\t\tclipx : pieceClipW,\n\t\t\t\t\t\t\tclipy : who==1?0:pieceClipW,\n\t\t\t\t\t\t\tclipwidth : pieceClipW,\n\t\t\t\t\t\t\tclipheight : pieceClipW,\n\t\t\t\t\t\t\twidth : VSIZE/.75,\n\t\t\t\t\t\t\theight : VSIZE/.75,\n\t\t\t\t\t\t\tx: VSIZE,\n\t\t\t\t\t\t\tz : 7,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"orange3d\":{\n\t\t\t\t\t\t\ttype:  \"custommesh3d\",\n\t\t\t\t\t\t\tcreate: function(callback){\n\t\t\t\t\t\t\t\tcreatePawn(this,callback,\"damyo\",who);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\trotate: who==1?90:-90,\n\t\t\t\t\t\t\tscale: [0.3,0.3,0.3],\t\t\t\t\t\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t})(who,i);\n\t\t\tfor(var i=0;i<this.mOptions.roninCount;i++)\n\t\t\t\t(function(who,i){\n\t\t\t\t\txdv.createGadget(\"ronin#\"+who+\"#\"+i,{\n\t\t\t\t\t\t\"2d\": {\n\t\t\t\t\t\t\ttype: \"sprite\",\n\t\t\t\t\t\t\tfile : fullPath + \"/res/images/manapieces.png\",\n\t\t\t\t\t\t\tclipx : 0,\n\t\t\t\t\t\t\tclipy : who==1?0:pieceClipW,\n\t\t\t\t\t\t\tclipwidth : pieceClipW,\n\t\t\t\t\t\t\tclipheight : pieceClipW,\n\t\t\t\t\t\t\twidth : VSIZE*1.1,\n\t\t\t\t\t\t\theight : VSIZE*1.1,\n\t\t\t\t\t\t\tx: VSIZE*i,\n\t\t\t\t\t\t\tz : 7,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"orange3d\":{\n\t\t\t\t\t\t\ttype:  \"custommesh3d\",\n\t\t\t\t\t\t\tcreate: function(callback){\n\t\t\t\t\t\t\t\tcreatePawn(this,callback,\"ronin\",who);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\trotate: who==1?90:-90,\n\t\t\t\t\t\t\tscale: [0.3,0.3,0.3],\t\t\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t})(who,i);\n\t\t}\n\t\txdv.createGadget(\"cancel\",{\n\t\t\t\"2d\": {\n\t\t\t\ttype : \"element\",\n\t\t\t\tinitialClasses: \"mana-cancel\",\n\t\t\t\ty: VSIZE*this.mOptions.height/(this.mOptions.height+2)*(this.mOptions.height/2+.5),\n\t\t\t\tz : 4,\n\t\t\t},\n\t\t\t\"orange3d\": {\n\t\t\t\ttype: \"meshfile\",\n\t\t\t\tfile: this.mViewOptions.fullPath + \"/res/xd-view/meshes/select-ring-undo.js\",\n\t\t\t\tsmooth: 0,\n\t\t\t\tscale: [1,1,1],\n\t\t\t\tmaterials:{\n\t\t\t\t\t\"ring\" : {\n\t\t\t\t\t\tshininess:10,\n\t\t\t\t\t\temissive:{r:.6,g:.6,b:.6},\n\t\t\t\t\t}\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\txdv.createGadget(\"mana\",{\n\t\t\t\"2d\": {\n\t\t\t\ttype: \"sprite\",\n\t\t\t\tfile : this.mViewOptions.fullPath + \"/res/images/manapieces.png\",\n\t\t\t\tclipx : 2*pieceClipW,\n\t\t\t\tclipy : 0,\n\t\t\t\tclipwidth : pieceClipW,\n\t\t\t\tclipheight : pieceClipW,\n\t\t\t\twidth : VSIZE*.9,\n\t\t\t\theight : VSIZE*.9,\n\t\t\t\tz : 8,\n\t\t\t},\n\t\t\t\"orange3d\": {\n\t\t\t\ttype: \"meshfile\",\n\t\t\t\tfile: this.mViewOptions.fullPath + \"/res/xd-view/meshes/mana.js\",\n\t\t\t\t//smooth: 2,\n\t\t\t\tscale: [1,1,1],\n\t\t\t\tmaterials:{\n\t\t\t\t\t\"manamat\":{\n\t\t\t\t\t\tshininess:500,\n\t\t\t\t\t\tspecular:{r:.3,g:.3,b:.3},\n\t\t\t\t\t\t//emissive:{r:.2,g:.2,b:.2},\n\t\t\t\t\t\tdiffuse:{r:.6,g:0,b:0},\n\t\t\t\t\t\tcolor:0xff0000,\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\t\n\tView.Game.xdBuildScene = function(xdv) {\n\t\tvar $this=this;\n\t\t\n\n\t\txdv.updateGadget(\"lightside\",{\n\t\t\t\"3d\": {\n\t\t\t\tvisible: true,\n\t\t\t},\n\t\t});\n\t\t\n\t\txdv.updateGadget(\"board\",{\n\t\t\t\"2d\": {\n\t\t\t\tvisible: true,\n\t\t\t},\n\t\t\t\"orange3d\": {\n\t\t\t\tvisible: true,\n\t\t\t\treceiveShadow: true,\n\t\t\t\tz:-500,\n\t\t\t},\n\t\t});\n\t\txdv.updateGadget(\"cancel\",{\n\t\t\t\"2d\": {\n\t\t\t\twidth : VSIZE*.85,\n\t\t\t\theight : VSIZE*.85,\n\t\t\t},\n\t\t});\n\t\t\n\t\tvar scaleScreen=3;\n\t\tvar zScreen=3000;\n\t\tvar zScreenVignette=1500;\n\t\tvar yScreen=10000;\n\t\tvar screenAngle=0;\n\t\tvar thumbDist=.89;\n\t\tvar thumbOffset=5500;\t\t\n\t\tvar inclination=25;\n\t\t\n\t\txdv.updateGadget(\"videoa\",{\n\t\t\t\"3d\": {\n\t\t\t\tvisible: true,\n\t\t\t\tplayerSide: 1,\n\t\t\t\tz: zScreen,\n\t\t\t\ty: this.mViewAs==1?yScreen:-yScreen,\n\t\t\t\trotate: this.mViewAs==1?-(180+screenAngle):-screenAngle,\n\t\t\t\trotateX: this.mViewAs==1?inclination:-inclination,\n\t\t\t\tscale: [scaleScreen,scaleScreen,scaleScreen],\n\t\t\t},\n\t\t});\n\t\txdv.updateGadget(\"videoabis\",{\n\t\t\t\"3d\": {\n\t\t\t\tvisible: true,\n\t\t\t\tplayerSide: -1,\n\t\t\t\tz: zScreenVignette,\n\t\t\t\tx: this.mViewAs==1?-thumbOffset:thumbOffset,\n\t\t\t\ty: this.mViewAs==1?thumbDist*yScreen:-thumbDist*yScreen,\n\t\t\t\trotate: this.mViewAs==1?-(180+screenAngle):-screenAngle,\n\t\t\t\trotateX: this.mViewAs==1?inclination:-inclination,\n\t\t\t\tscale: [scaleScreen/4,scaleScreen/4,scaleScreen/4],\n\t\t\t},\n\t\t});\n\n\t\txdv.updateGadget(\"videob\",{\n\t\t\t\"3d\": {\n\t\t\t\tvisible: true,\n\t\t\t\tplayerSide: -1,\n\t\t\t\tz: zScreen,\n\t\t\t\ty: this.mViewAs==1?-yScreen:yScreen,\n\t\t\t\trotate: this.mViewAs==1?-screenAngle:-(180+screenAngle),\n\t\t\t\trotateX: this.mViewAs==1?-inclination:inclination,\n\t\t\t\tscale: [scaleScreen,scaleScreen,scaleScreen],\n\t\t\t},\n\t\t});\n\t\txdv.updateGadget(\"videobbis\",{\n\t\t\t\"3d\": {\n\t\t\t\tvisible: true,\n\t\t\t\tplayerSide: 1,\n\t\t\t\tz: zScreenVignette,\n\t\t\t\tx: this.mViewAs==1?thumbOffset:-thumbOffset,\n\t\t\t\ty: this.mViewAs==1?-thumbDist*yScreen:thumbDist*yScreen,\n\t\t\t\trotate: this.mViewAs==1?-screenAngle:-(180+screenAngle),\n\t\t\t\trotateX: this.mViewAs==1?-inclination:inclination,\n\t\t\t\tscale: [scaleScreen/4,scaleScreen/4,scaleScreen/4],\n\t\t\t},\n\t\t});\t\t\n\n\t\t\n\t\tfor(var who=1;who>=-1;who-=2) {\n\t\t\tfor(var i=0;i<$this.mOptions.damyoCount;i++) {\n\t\t\t\tvar pieceId=\"damyo#\"+who+\"#\"+i;\n\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\t\"orange3d\": {\n\t\t\t\t\t\trotate: ($this.mViewAs==JocGame.PLAYER_B?180:0) + (who==1?90:-90),\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\tfor(var i=0;i<$this.mOptions.roninCount;i++) {\n\t\t\t\tvar pieceId=\"ronin#\"+who+\"#\"+i;\n\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\t\"orange3d\": {\n\t\t\t\t\t\trotate: ($this.mViewAs==JocGame.PLAYER_B?180:0) + (who==1?90:-90),\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\t\n\tView.Board.getRCCoord = function(aGame,pos,orient) {\n\t\tvar r=Math.floor(pos/aGame.mOptions.width);\n\t\tvar c=pos%aGame.mOptions.width;\n\t\tif(arguments.length<3)\n\t\t\torient=this.orient;\n\t\tif(orient==\"NE\" || orient==\"SW\") {\n\t\t\tvar t=r;\n\t\t\tr=c;\n\t\t\tc=t;\n\t\t}\n\t\tif(orient==\"NE\" || orient==\"NW\")\n\t\t\tc=aGame.mOptions.width-1-c;\n\t\tif(orient==\"NE\" || orient==\"SE\")\n\t\t\tr=aGame.mOptions.height-1-r;\n\t\treturn [r,c];\n\t}\n\n\tView.Board.getVCoord = function(aGame,pos,orient) {\n\t\tif(aGame.mViewAs==JocGame.PLAYER_B)\n\t\t\tpos=aGame.g.Graph.length-1-pos;\n\t\tvar rcCoord=this.getRCCoord(aGame,pos,orient);\n\t\tvar r=rcCoord[0];\n\t\tvar c=rcCoord[1];\n\t\treturn [VSIZE*(-aGame.mOptions.height/2+r+.5),VSIZE*(-aGame.mOptions.width/2+c+.5)];\n\t}\n\t\n\tView.Board.pieceOutPosition = function(aGame,piece) {\n\t\tvar damyoCount=aGame.mOptions.damyoCount;\n\t\tvar piecesCount=aGame.mOptions.roninCount+damyoCount;\n\t\tvar slot=12000/piecesCount;\n\t\tvar y = VSIZE*3.8;\n\t\tif(piece.t==\"d\")\n\t\t\tx=((piece.i-piecesCount/2)+.5)*slot;\n\t\telse\n\t\t\tx=((damyoCount+piece.i-piecesCount/2)+.5)*slot;\n\t\tif(aGame.mViewAs!=piece.s) {\n\t\t\ty=-y;\n\t\t\tx=-x;\n\t\t}\n\t\treturn [x,y]\n\t}\n\n\tView.Board.manaUpdateCells = function(xdv, aGame, orient) {\n\t\tfor(var pos=0;pos<aGame.g.Graph.length;pos++) {\n\t\t\tvar coord=this.getVCoord(aGame,pos,orient);\n\t\t\txdv.updateGadget(\"text#\"+pos,{\n\t\t\t\tbase: { \n\t\t\t\t\tvisible: aGame.mNotation && this.stage!=1,\n\t\t\t\t\tx: coord[0],\n\t\t\t\t\ty: coord[1],\n\t\t\t\t},\n\t\t\t});\n\t\t\txdv.updateGadget(\"cell#\"+pos,{\n\t\t\t\tbase: {\n\t\t\t\t\tx: coord[0],\n\t\t\t\t\ty: coord[1],\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t}\n\n\tView.Board.xdDisplay = function(xdv, aGame) {\n\t\tthis.manaUpdateCells(xdv,aGame,this.orient);\n\t\tif(this.stage==1)\n\t\t\txdv.updateGadget(\"board\",{\n\t\t\t\t\"2d\": {\n\t\t\t\t\trotate : 45,\n\t\t\t\t\twidth: VSIZE*aGame.mOptions.width*.7,\n\t\t\t\t\theight: VSIZE*aGame.mOptions.height*.7,\n\t\t\t\t},\n\t\t\t\t\"orange3d\":{\n\t\t\t\t\trotate: 45,\n\t\t\t\t}\n\t\t\t});\n\t\telse {\n\t\t\tvar angle=aGame.g.Orients[this.orient].angle;\n\t\t\txdv.updateGadget(\"board\",{\n\t\t\t\t\"2d\": {\n\t\t\t\t\trotate: aGame.mViewAs==JocGame.PLAYER_B?angle+180:angle,\n\t\t\t\t\twidth: VSIZE*aGame.mOptions.width/0.75,\n\t\t\t\t\theight: VSIZE*aGame.mOptions.height/0.75,\n\t\t\t\t},\n\t\t\t\t\"orange3d\": {\n\t\t\t\t\trotate: aGame.mViewAs==JocGame.PLAYER_B?-angle+180+90:-angle+90,\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t\tif(this.mana<0){\n\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: false,\n\t\t\t\t\tx: -7000,\n\t\t\t\t\ty: 0,\n\t\t\t\t},\n\t\t\t\t\"orange3d\":{\n\t\t\t\t\t// z: 1200,\n\t\t\t\t\tscale: [0.3,0.3,0.3],\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t\telse {\n\t\t\tvar pieceType=\"r\";\n\t\t\tif (this.board[this.mana]>=0){\n\t\t\t\tpieceType=this.pieces[this.board[this.mana]].t;\n\t\t\t}\n\t\t\tvar coord=this.getVCoord(aGame,this.mana,this.orient);\n\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: true,\n\t\t\t\t\tx: coord[0],\n\t\t\t\t\ty: coord[1],\n\t\t\t\t\tscale:[0.3,0.3,0.3],//pieceType==\"r\"?[0.3,0.3,0.3]:[0.4,0.4,0.4],\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t\tfunction HidePieces(side) {\n\t\t\tfor(var i=0;i<aGame.mOptions.damyoCount;i++) {\n\t\t\t\tvar pieceId=\"damyo#\"+side+\"#\"+i;\n\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tvisible: false,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\tfor(var i=0;i<aGame.mOptions.roninCount;i++) {\n\t\t\t\tvar pieceId=\"ronin#\"+side+\"#\"+i;\n\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tvisible: false,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tif(this.stage==1) {\n\t\t\tHidePieces(JocGame.PLAYER_A);\n\t\t\tHidePieces(JocGame.PLAYER_B);\n\t\t} else \tif(this.stage<=2)\n\t\t\tHidePieces(JocGame.PLAYER_B);\n\t\tfor(var i=0;i<this.pieces.length;i++) {\n\t\t\tvar piece=this.pieces[i];\n\t\t\tvar pieceId=(piece.t==\"d\"?\"damyo\":\"ronin\")+\"#\"+piece.s+\"#\"+piece.i;\n\t\t\tif(piece.p<0) {\n\t\t\t\tif(this.stage<3)\n\t\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\t\tbase: {\n\t\t\t\t\t\t\tvisible: false,\n\t\t\t\t\t\t\tx: 0,\n\t\t\t\t\t\t\ty: 0,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"2d\":{\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"orange3d\": {\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\telse {\n\t\t\t\t\tvar coord=this.pieceOutPosition(aGame,piece);\n\t\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\t\tbase: {\n\t\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"2d\": {\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"orange3d\": {\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tvar coord=this.getVCoord(aGame,piece.p,this.orient);\n\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t},\n\t\t\t\t\t\"2d\": {\n\t\t\t\t\t\tz: 7,\n\t\t\t\t\t},\n\t\t\t\t\t\"orange3d\": {\n\t\t\t\t\t}\n\t\t\t\t});\t\t\t\t\n\t\t\t}\n\t\t}\n\t}\n\t\t\n\tfunction MoveSound(aGame, type){\n\t\tswitch(type){\n\t\t\tdefault:\n\t\t\t\taGame.PlaySound('zip'+Math.floor(Math.random()*4));\n\t\t\t\tbreak;\n\t\t\tcase 'mana':\n\t\t\t\taGame.PlaySound('wind');\n\t\t\t\tbreak;\n\t\t}\n\t}\t\n\n\tView.Board.xdBuildHTStateMachine = function(xdv, htsm, aGame) {\n\t\tvar $this = this;\n\t\tvar orients=[\"NW\",\"NE\",\"SW\",\"SE\"];\n\t\tvar orient;\n\t\tvar damyo=[];\n\t\tvar ronin=[];\n\t\tvar movables;\n\t\tvar moveStart,moveEnd;\n\t\tvar move;\n\t\t\n\t\tfunction HighLight(pos,type) {\n\t\t\tvar pieceIndex=$this.board[pos];\n\t\t\tvar piece=null;\n\t\t\tvar pieceId=null;\n\t\t\tif(pieceIndex>=0) {\n\t\t\t\tpiece=$this.pieces[pieceIndex];\n\t\t\t\tpieceId=(piece.t==\"r\"?\"ronin\":\"damyo\")+\"#\"+piece.s+\"#\"+piece.i;\n\t\t\t}\n\t\t\txdv.updateGadget(\"cell#\"+pos,{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: true,\n\t\t\t\t\tclick: function() {\n\t\t\t\t\t\thtsm.smQueueEvent(\"E_CLICK\",{pos:pos,type:type});\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t\"2d\":{\n\t\t\t\t\tclasses: (type==\"cancel\"?\"mana-cancel mana-select-view\":\"\")+(aGame.mShowMoves?\" mana-select-view\":\"\"),\n\t\t\t\t},\n\t\t\t});\n\t\t\tif(pieceId)\n\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tclick: function() {\n\t\t\t\t\t\t\thtsm.smQueueEvent(\"E_CLICK\",{pos:pos,type:type});\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\tif(pos==$this.mana)\n\t\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tclick: function() {\n\t\t\t\t\t\t\thtsm.smQueueEvent(\"E_CLICK\",{pos:pos,type:type});\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t}\n\t\tfunction Init(args) {\n\t\t}\n\t\tfunction Clean(args) {\n\t\t\tfor(var pos=0;pos<aGame.g.Graph.length;pos++)\n\t\t\t\txdv.updateGadget(\"cell#\"+pos,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tvisible: false,\n\t\t\t\t\t\tclick: null,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\tfor(var s=-1;s<=1;s+=2) {\n\t\t\t\tfor(var i=0;i<aGame.mOptions.damyoCount;i++)\n\t\t\t\t\txdv.updateGadget(\"damyo#\"+s+\"#\"+i,{\n\t\t\t\t\t\tbase: {\n\t\t\t\t\t\t\tclick: null,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\tfor(var i=0;i<aGame.mOptions.roninCount;i++)\n\t\t\t\t\txdv.updateGadget(\"ronin#\"+s+\"#\"+i,{\n\t\t\t\t\t\tbase: {\n\t\t\t\t\t\t\tclick: null,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t}\n\t\t\txdv.updateGadget(\"cancel\",{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: false,\n\t\t\t\t\tclick: null,\n\t\t\t\t},\n\t\t\t});\n\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\tbase: {\n\t\t\t\t\tclick: null,\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t\tfunction Stage(args) {\n\t\t\tif($this.stage<=2)\n\t\t\t\thtsm.smQueueEvent(\"E_STAGE\"+$this.stage,{});\n\t\t\telse {\n\t\t\t\tvar pieces=$this.manaMovablePieces(aGame);\n\t\t\t\thtsm.smQueueEvent(\"E_MOVE\",{movables:pieces});\n\t\t\t}\n\t\t}\n\t\tfunction Orient(args) {\n\t\t\tfor(var pos=0;pos<aGame.g.Graph.length;pos++)\n\t\t\t\txdv.updateGadget(\"text#\"+pos,{\n\t\t\t\t\tbase: { visible: false },\n\t\t\t\t});\n\t\t\txdv.updateGadget(\"board\",{\n\t\t\t\t\"2d\": {\n\t\t\t\t\twidth: VSIZE*aGame.mOptions.width*.7,\n\t\t\t\t\theight: VSIZE*aGame.mOptions.height*.7,\n\t\t\t\t\trotate: 45,\n\t\t\t\t},\n\t\t\t\t\"orange3d\":{\n\t\t\t\t\trotate: 45,\n\t\t\t\t}\n\t\t\t});\n\t\t\tfor(var i=0; i<orients.length; i++) {\n\t\t\t\t(function(orient) {\n\t\t\t\t\txdv.updateGadget(\"orient#\"+orient,{\n\t\t\t\t\t\tbase: {\n\t\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t\t\tclick: function() {\n\t\t\t\t\t\t\t\thtsm.smQueueEvent(\"E_ORIENT\",{orient:orient});\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t})(orients[i]);\n\t\t\t}\n\t\t}\n\t\tfunction ExitOrient(args) {\n\t\t\tfor(var i=0; i<orients.length; i++) {\n\t\t\t\t(function(orient) {\n\t\t\t\t\txdv.updateGadget(\"orient#\"+orient,{\n\t\t\t\t\t\tbase: {\n\t\t\t\t\t\t\tvisible: false,\n\t\t\t\t\t\t\tclick: null,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t})(orients[i]);\n\t\t\t}\n\t\t}\n\t\tfunction Pivot(args) {\n\t\t\taGame.PlaySound(\"chains\");\n\t\t\txdv.updateGadget(\"board\",{\n\t\t\t\t\"orange3d\": {\n\t\t\t\t\trotate: -aGame.g.Orients[args.orient].angle+90,\n\t\t\t\t},\n\t\t\t\t\"2d\":{\n\t\t\t\t\trotate: aGame.g.Orients[args.orient].angle,\n\t\t\t\t\twidth: VSIZE*aGame.mOptions.width/.75,\n\t\t\t\t\theight: VSIZE*aGame.mOptions.height/.75,\n\t\t\t\t}\n\t\t\t},1000,function() {\n\t\t\t\thtsm.smQueueEvent(\"E_ORIENT_DONE\",{orient:args.orient});\n\t\t\t});\n\t\t}\n\t\tfunction UpdateCells(args) {\n\t\t\t$this.manaUpdateCells(xdv,aGame,args.orient);\n\t\t}\n\t\tfunction HighlightCancel(args) {\n\t\t\txdv.updateGadget(\"cancel\",{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: true,\n\t\t\t\t\tclick: function() {\n\t\t\t\t\t\thtsm.smQueueEvent(\"E_CANCEL\",{});\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\t\t\t\n\t\t}\n\t\tfunction UnHighlightCancel(args) {\n\t\t\txdv.updateGadget(\"cancel\",{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: false,\n\t\t\t\t\tclick: null,\n\t\t\t\t},\n\t\t\t});\t\n\t\t}\n\t\tfunction ShowPlacingPieces(args) {\n\t\t\n\t\t\taGame.PlaySound(\"sabers\");\n\n\t\t\tfor(var i=0;i<aGame.mOptions.damyoCount;i++) {\n\t\t\t\tvar pieceId=\"damyo#\"+$this.mWho+\"#\"+i;\n\t\t\t\tvar coord=$this.pieceOutPosition(aGame,{\n\t\t\t\t\tt: \"d\",\n\t\t\t\t\ts: $this.mWho,\n\t\t\t\t\ti: i,\n\t\t\t\t});\n\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t},\n\t\t\t\t});\t\t\t\t\n\t\t\t}\n\t\t\tfor(var i=0;i<aGame.mOptions.roninCount;i++) {\n\t\t\t\tvar pieceId=\"ronin#\"+$this.mWho+\"#\"+i;\n\t\t\t\tvar coord=$this.pieceOutPosition(aGame,{\n\t\t\t\t\tt: \"r\",\n\t\t\t\t\ts: $this.mWho,\n\t\t\t\t\ti: i,\n\t\t\t\t});\n\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t},\n\t\t\t\t});\t\t\t\t\n\t\t\t}\n\t\t}\n\t\tfunction PlacePiece(args) {\n\t\t\tvar piece=null;\n\t\t\tvar pieceType;\n\t\t\tvar pieceIndex;\n\t\t\tif(damyo.length<aGame.mOptions.damyoCount) {\n\t\t\t\tpiece=\"damyo#\"+$this.mWho+\"#\"+damyo.length;\n\t\t\t\tpieceType='d';\n\t\t\t\tpieceIndex=damyo.length;\n\t\t\t} else if(ronin.length<aGame.mOptions.roninCount) {\n\t\t\t\tpiece=\"ronin#\"+$this.mWho+\"#\"+ronin.length;\n\t\t\t\tpieceType=\"r\";\n\t\t\t\tpieceIndex=ronin.length;\n\t\t\t} else {\n\t\t\t\thtsm.smQueueEvent(\"E_ALL_PLACED\",{});\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar cancelCoord=$this.pieceOutPosition(aGame,{\n\t\t\t\tt: pieceType,\n\t\t\t\ts: $this.mWho,\n\t\t\t\ti: pieceIndex,\n\t\t\t});\n\t\t\txdv.updateGadget(\"cancel\",{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: true,\n\t\t\t\t\tx: cancelCoord[0],\n\t\t\t\t\ty: cancelCoord[1],\n\t\t\t\t},\n\t\t\t\t\"2d\":{\n\t\t\t\t\twidth : VSIZE*.85,\n\t\t\t\t\theight : VSIZE*.85,\n\t\t\t\t}\n\t\t\t});\n\t\t\txdv.updateGadget(piece,{\n\t\t\t\tbase: {\n\t\t\t\t\tclick: function() {\n\t\t\t\t\t\thtsm.smQueueEvent(\"E_CANCEL\",{});\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t}); \n\t\t\tvar poss=[];\n\t\t\tfor(var pos=0;pos<aGame.g.Graph.length;pos++) {\n\t\t\t\tvar rc=$this.getRCCoord(aGame,pos,orient?orient:$this.orient);\n\t\t\t\tvar coord=$this.getVCoord(aGame,pos,orient?orient:$this.orient);\n\t\t\t\tif(($this.mWho==-1 && rc[1]<=1) || ($this.mWho==1 && rc[1]>=aGame.mOptions.width-2)) {\n\t\t\t\t\tvar taken=false;\n\t\t\t\t\tfor(var i=0;i<damyo.length;i++)\n\t\t\t\t\t\tif(damyo[i]==pos)\n\t\t\t\t\t\t\ttaken=true;\n\t\t\t\t\tfor(var i=0;i<ronin.length;i++)\n\t\t\t\t\t\tif(ronin[i]==pos)\n\t\t\t\t\t\t\ttaken=true;\n\t\t\t\t\tif(!taken)\n\t\t\t\t\t\t(function(pos) {\n\t\t\t\t\t\t\txdv.updateGadget(\"cell#\"+pos,{\n\t\t\t\t\t\t\t\tbase: {\n\t\t\t\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t\t\t\t\tclick: function() {\n\t\t\t\t\t\t\t\t\t\thtsm.smQueueEvent(\"E_PLACE\",{\n\t\t\t\t\t\t\t\t\t\t\tpos: pos,\n\t\t\t\t\t\t\t\t\t\t\tpieceId: piece,\n\t\t\t\t\t\t\t\t\t\t\tpieceType: pieceType,\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"2d\": {\n\t\t\t\t\t\t\t\t\tclasses: (aGame.mShowMoves?\"mana-select-view\":\"\"),\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t})(pos);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfunction SaveOrient(args) {\n\t\t\torient=args.orient;\n\t\t}\n\t\tfunction MovePlacePiece(args) {\n\t\t\tMoveSound(aGame);\n\t\t\tvar coord=$this.getVCoord(aGame,args.pos,orient?orient:$this.orient);\n\t\t\txdv.updateGadget(args.pieceId,{\n\t\t\t\tbase: {\n\t\t\t\t\tx: coord[0],\n\t\t\t\t\ty: coord[1],\n\t\t\t\t},\n\t\t\t},400,function() {\n\t\t\t\thtsm.smQueueEvent(\"E_PLACED\",args);\n\t\t\t});\n\t\t}\n\t\tfunction SavePlace(args) {\n\t\t\tif(args.pieceType==\"d\")\n\t\t\t\tdamyo.push(args.pos);\n\t\t\tif(args.pieceType==\"r\")\n\t\t\t\tronin.push(args.pos);\n\t\t}\n\t\tfunction SendPlaceMove(args) {\n\t\t\tvar move={\n\t\t\t\tp: {\n\t\t\t\t\td: damyo,\n\t\t\t\t\tr: ronin,\n\t\t\t\t},\n\t\t\t};\n\t\t\tif($this.mWho==1)\n\t\t\t\tmove.o=orient;\n\t\t\taGame.MakeMove(move);\n\t\t}\n\t\tfunction HidePieces(args) {\n\t\t\tfor(var i=0;i<aGame.mOptions.damyoCount;i++)\n\t\t\t\txdv.updateGadget(\"damyo#\"+$this.mWho+\"#\"+i,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tvisible: false,\n\t\t\t\t\t\tx: 0,\n\t\t\t\t\t\ty: 0,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\tfor(var i=0;i<aGame.mOptions.roninCount;i++)\n\t\t\t\txdv.updateGadget(\"ronin#\"+$this.mWho+\"#\"+i,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tvisible: false,\n\t\t\t\t\t\tx: 0,\n\t\t\t\t\t\ty: 0,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t}\n\t\tfunction ClearPieces(args) {\n\t\t\tdamyo=[];\n\t\t\tronin=[];\n\t\t}\n\t\tfunction SelectStart(args) {\n\t\t\tvar validMoves=[];\n\t\t\tvar mana=-1;\n\t\t\tif($this.mana>=0)\n\t\t\t\tmana=aGame.g.CValue[$this.mana];\n\t\t\tfor(var i in movables) \n\t\t\t\tif(movables.hasOwnProperty(i)) {\n\t\t\t\t\tvar piece=$this.pieces[i];\n\t\t\t\t\tif(mana<0 || aGame.g.CValue[piece.p]==mana) {\n\t\t\t\t\t\tvalidMoves.push({\n\t\t\t\t\t\t\ttype: 'move',\n\t\t\t\t\t\t\tpieceIndex: i,\n\t\t\t\t\t\t\tmovable: movables[i],\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\tif(validMoves.length==0) {\n\t\t\t\tfor(var i in movables) \n\t\t\t\t\tif(movables.hasOwnProperty(i)) {\n\t\t\t\t\t\tvalidMoves.push({\n\t\t\t\t\t\t\ttype: 'move',\n\t\t\t\t\t\t\tpieceIndex: i,\n\t\t\t\t\t\t\tmovable: movables[i],\t\t\t\t\t\t\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\tif($this.roninOut[$this.mWho]>0)\n\t\t\t\t\tfor(var pos=0;pos<aGame.g.Graph.length;pos++) {\n\t\t\t\t\t\tif($this.board[pos]<0 && (aGame.mOptions.insertAnywhere || aGame.g.CValue[pos]==mana))\n\t\t\t\t\t\t\tvalidMoves.push({\n\t\t\t\t\t\t\t\ttype: 'insert',\n\t\t\t\t\t\t\t\tpos: pos,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t}\n\t\t\tfor(var i=0;i<validMoves.length;i++) {\n\t\t\t\tvar move=validMoves[i];\n\t\t\t\tswitch(move.type) {\n\t\t\t\tcase \"insert\":\n\t\t\t\t\tHighLight(move.pos,\"insert\");\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"move\":\n\t\t\t\t\tHighLight($this.pieces[move.pieceIndex].p,\"move\");\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfunction SaveMovables(args) {\n\t\t\tmovables=args.movables;\n\t\t}\n\t\tfunction ClickStart(args) {\n\t\t\tif($this.board[args.pos]<0)\n\t\t\t\thtsm.smQueueEvent(\"E_CELL_CLICK\",{pos:args.pos});\n\t\t\telse\n\t\t\t\thtsm.smQueueEvent(\"E_PIECE_CLICK\",{pieceIndex:$this.board[args.pos]});\n\t\t}\n\t\tfunction SelectEnd(args) {\n\t\t\tvar movable=movables[args.pieceIndex];\n\t\t\tfor(var pos in movable)\n\t\t\t\tif(movable.hasOwnProperty(pos))\n\t\t\t\t\tHighLight(pos,\"dest\");\n\t\t\txdv.updateGadget(\"cancel\",{\n\t\t\t\t\"2d\": {\n\t\t\t\t\twidth : VSIZE*1.05,\n\t\t\t\t\theight : VSIZE*1.05,\n\t\t\t\t},\n\t\t\t});\n\t\t\tHighLight(moveStart,\"cancel\");\n\t\t}\n\t\tfunction ClickEnd(args) {\n\t\t\tif(args.type==\"cancel\")\n\t\t\t\thtsm.smQueueEvent(\"E_CANCEL\",{});\n\t\t\telse\n\t\t\t\thtsm.smQueueEvent(\"E_MOVE_COMPLETE\",{pos:args.pos});\n\t\t}\n\t\tfunction SaveMove(args) {\n\t\t\tmove={\n\t\t\t\tm:[moveStart,moveEnd],\n\t\t\t};\n\t\t}\n\t\tfunction SaveMoveEnd(args) {\n\t\t\tmoveEnd=args.pos;\n\t\t}\n\t\tfunction SaveMoveStart(args) {\n\t\t\tmoveStart=args.pos;\n\t\t}\n\t\tfunction AnimateMove(args) {\n\t\t\tvar duration=400;\n\t\t\tvar pieceIndex=$this.board[moveStart];\n\t\t\tvar piece=$this.pieces[pieceIndex];\n\t\t\tvar pieceId=(piece.t==\"d\"?\"damyo\":\"ronin\")+\"#\"+$this.mWho+\"#\"+piece.i;\n\t\t\tvar animPath=movables[pieceIndex][moveEnd];\n\t\t\tvar animIndex=1;\n\t\t\tfunction AnimateSegment() {\n\t\t\t\tMoveSound(aGame);\n\t\t\t\tvar coord=$this.getVCoord(aGame,animPath[animIndex],$this.orient);\n\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t},\n\t\t\t\t\t\"2d\":{\n\t\t\t\t\t\tz: 8,\n\t\t\t\t\t},\n\t\t\t\t\t\"orange3d\":{\n\t\t\t\t\t\t//z: ?,\n\t\t\t\t\t},\n\t\t\t\t},duration,function() {\n\t\t\t\t\tanimIndex++;\n\t\t\t\t\tif(animIndex==animPath.length)\n\t\t\t\t\t\thtsm.smQueueEvent(\"E_ANIM_DONE\",{});\n\t\t\t\t\telse\n\t\t\t\t\t\tAnimateSegment();\n\t\t\t\t});\n\t\t\t}\n\t\t\tAnimateSegment();\n\t\t}\n\t\tfunction AnimateInsert(args) {\n\t\t\tvar piece;\n\t\t\tfor(var i=0;i<$this.pieces.length;i++) {\n\t\t\t\tpiece=$this.pieces[i];\n\t\t\t\tif(piece.t==\"r\" && piece.s==$this.mWho && piece.p<0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tvar pieceId=\"ronin#\"+piece.s+\"#\"+piece.i;\n\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: true,\n\t\t\t\t},\n\t\t\t});\n\t\t\tvar coord=$this.getVCoord(aGame,moveStart,$this.orient);\n\t\t\tMoveSound(aGame);\n\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: true,\n\t\t\t\t\tx: coord[0],\n\t\t\t\t\ty: coord[1],\n\t\t\t\t},\n\t\t\t},400,function() {\n\t\t\t\thtsm.smQueueEvent(\"E_ANIM_DONE\",{});\t\t\t\t\n\t\t\t});\n\t\t}\n\t\tfunction SaveInsert(args) {\n\t\t\tmove={\n\t\t\t\ti:moveStart,\n\t\t\t};\n\t\t}\n\t\tfunction SendMove(args) {\n\t\t\taGame.MakeMove(move);\n\t\t}\n\t\tfunction AnimateMana() {\n\t\t\t\n\t\t\tMoveSound(aGame,'mana');\n\t\t\t\n\t\t\tvar mana=move.m?move.m[1]:move.i;\n\t\t\tif(mana==$this.mana) {\n\t\t\t\thtsm.smQueueEvent(\"E_ANIM_DONE\",{});\t\t\t\t\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif($this.mana<0)\n\t\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\t\t\"2d\": {\n\t\t\t\t\t\tx: -VSIZE*aGame.mOptions.width/(aGame.mOptions.width+2)*(aGame.mOptions.width/2+.5),\n\t\t\t\t\t\ty: 0,\n\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t},\n\t\t\t\t\t\"orange3d\":{\n\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\tvar coord=$this.getVCoord(aGame,mana,$this.orient)\n\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: true,\n\t\t\t\t},\n\t\t\t\t\"3d\":{\n\t\t\t\t\tz: 1000,\n\t\t\t\t}\n\t\t\t},200,function(){\n\t\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t},\n\t\t\t\t},400,function() {\n\t\t\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\t\t\t\"3d\": {\n\t\t\t\t\t\t\tz: 0,\n\t\t\t\t\t\t},\n\t\t\t\t\t},200,function(){\n\t\t\t\t\t\thtsm.smQueueEvent(\"E_ANIM_DONE\",{});\t\t\t\t\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t\t\n\n\t\t}\n\t\tfunction AnimateCapture() {\n\t\t\tvar pieceIndex=$this.board[moveEnd];\n\t\t\tif(pieceIndex<0)\n\t\t\t\thtsm.smQueueEvent(\"E_ANIM_DONE\",{});\n\t\t\telse {\n\t\t\t\tvar piece=$this.pieces[pieceIndex];\n\t\t\t\tvar coord=$this.pieceOutPosition(aGame,piece);\n\t\t\t\t\n\t\t\t\tif (piece.t==\"d\"){\n\t\t\t\t\taGame.PlaySound('deathdamyo');\n\t\t\t\t}else{\n\t\t\t\t\taGame.PlaySound('sabers');\n\t\t\t\t\taGame.PlaySound('death'+Math.ceil(Math.random()*3));\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\txdv.updateGadget((piece.t==\"d\"?\"damyo#\":\"ronin#\")+piece.s+\"#\"+piece.i,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t},\n\t\t\t\t},400,function() {\n\t\t\t\t\thtsm.smQueueEvent(\"E_ANIM_DONE\",{});\t\t\t\t\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\t\n\t\thtsm.smTransition(\"S_INIT\",\"E_INIT\",\"S_READY\",[Init]);\n\t\thtsm.smEntering(\"S_READY\",[Stage]);\n\t\thtsm.smTransition(\"S_READY\",\"E_STAGE1\",\"S_STAGE1\",[]);\n\t\thtsm.smEntering(\"S_STAGE1\",[HidePieces,Orient]);\n\t\thtsm.smTransition(\"S_STAGE1\",\"E_ORIENT\",\"S_ORIENTING\",[Pivot]);\n\t\thtsm.smLeaving(\"S_STAGE1\",[Clean,ExitOrient]);\n\t\thtsm.smTransition(\"S_ORIENTING\",\"E_ORIENT_DONE\",\"S_PLACING\",[SaveOrient,UpdateCells,ShowPlacingPieces]);\n\t\t\n\t\thtsm.smTransition(\"S_READY\",\"E_STAGE2\",\"S_PLACING\",[UpdateCells,ShowPlacingPieces]);\n\t\t\n\t\thtsm.smTransition(\"S_READY\",\"E_STAGE3\",\"S_PLACING\",[UpdateCells,HidePieces]);\n\n\t\thtsm.smTransition(\"S_READY\",\"E_MOVE\",\"S_SELECT\",[SaveMovables]);\n\n\t\thtsm.smEntering(\"S_SELECT\",[SelectStart]);\n\t\thtsm.smLeaving(\"S_SELECT\",[Clean]);\n\t\thtsm.smTransition(\"S_SELECT\",\"E_CLICK\",null,[SaveMoveStart,ClickStart]);\n\t\thtsm.smTransition(\"S_SELECT\",\"E_PIECE_CLICK\",\"S_SELECT2\",[]);\n\n\t\thtsm.smTransition(\"S_SELECT\",\"E_CELL_CLICK\",\"S_ANIM_INSERT\",[SaveMoveStart,AnimateInsert]);\n\t\thtsm.smTransition(\"S_ANIM_INSERT\",\"E_ANIM_DONE\",\"S_ANIM_MANA\",[SaveInsert]);\n\n\t\thtsm.smEntering(\"S_SELECT2\",[SelectEnd]);\n\t\thtsm.smTransition(\"S_SELECT2\",\"E_CLICK\",null,[ClickEnd]);\n\t\thtsm.smTransition(\"S_SELECT2\",\"E_CANCEL\",\"S_SELECT\",[]);\n\t\thtsm.smTransition(\"S_SELECT2\",\"E_MOVE_COMPLETE\",\"S_ANIM_MOVE\",[SaveMoveEnd,AnimateMove]);\n\t\thtsm.smLeaving(\"S_SELECT2\",[Clean]);\n\t\t\n\t\thtsm.smTransition(\"S_ANIM_MOVE\",\"E_ANIM_DONE\",\"S_ANIM_CAPT\",[SaveMove]);\n\t\t\n\t\thtsm.smTransition(\"S_PLACING\",\"E_CANCEL\",\"S_READY\",[ClearPieces]);\n\t\thtsm.smTransition(\"S_PLACING\",\"E_ALL_PLACED\",null,[SendPlaceMove]);\n\t\thtsm.smEntering(\"S_PLACING\",[HighlightCancel,PlacePiece]);\n\t\thtsm.smLeaving(\"S_PLACING\",[UnHighlightCancel,Clean]);\n\t\thtsm.smTransition(\"S_PLACING\",\"E_PLACE\",\"S_ANIM_PLACE\",[SavePlace,MovePlacePiece]);\n\t\thtsm.smEntering(\"S_ANIM_PLACE\",[]);\n\t\thtsm.smTransition(\"S_ANIM_PLACE\",\"E_PLACED\",\"S_PLACING\",[]);\n\t\t\n\t\thtsm.smEntering(\"S_ANIM_MANA\",[AnimateMana]);\n\t\thtsm.smTransition(\"S_ANIM_MANA\",\"E_ANIM_DONE\",null,[SendMove]);\n\n\t\thtsm.smEntering(\"S_ANIM_CAPT\",[AnimateCapture]);\n\t\thtsm.smTransition(\"S_ANIM_CAPT\",\"E_ANIM_DONE\",\"S_ANIM_MANA\",[]);\n\n\t\t\n\t\thtsm.smTransition([\"S_READY\",\"S_STAGE1\",\"S_ORIENTING\",\"S_PLACING\",\"S_ANIM_PLACE\",\"S_SELECT\",\"S_SELECT2\",\"S_ANIM_MOVE\",\"S_ANIM_INSERT\",\"S_ANIM_MANA\"],\"E_END\",\"S_END\",[]);\n\t\thtsm.smEntering(\"S_END\",[Clean]);\n\t}\n\t\n\tView.Board.xdPlayedMove = function(xdv, aGame, aMove) {\n\t\tvar $this=this;\n\t\tfunction PlacePieces() {\n\t\t\tvar pieces=[];\n\t\t\tvar piecesIndex=0;\n\t\t\tfor(var i=0;i<aMove.p.d.length;i++) {\n\t\t\t\tpieces.push({\n\t\t\t\t\tpieceId: \"damyo#\"+$this.mWho+\"#\"+i,\n\t\t\t\t\tpos: aMove.p.d[i],\n\t\t\t\t\tt: \"d\",\n\t\t\t\t\ti: i,\n\t\t\t\t\ts: $this.mWho,\n\t\t\t\t});\n\t\t\t}\n\t\t\tfor(var i=0;i<aMove.p.r.length;i++) {\n\t\t\t\tpieces.push({\n\t\t\t\t\tpieceId: \"ronin#\"+$this.mWho+\"#\"+i,\n\t\t\t\t\tpos: aMove.p.r[i],\n\t\t\t\t\tt: \"d\",\n\t\t\t\t\ti: i,\n\t\t\t\t\ts: $this.mWho,\n\t\t\t\t});\n\t\t\t}\n\t\t\tfor(var i=0;i<pieces.length;i++) {\n\t\t\t\tvar coord=$this.pieceOutPosition(aGame,pieces[i]);\n\t\t\t\txdv.updateGadget(pieces[i].pieceId,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\tfunction Animate() {\n\t\t\t\tMoveSound(aGame);\n\t\t\t\tvar piece=pieces[piecesIndex];\n\t\t\t\tvar coord=$this.getVCoord(aGame,piece.pos,$this.orient);\n\t\t\t\txdv.updateGadget(piece.pieceId,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t},\n\t\t\t\t},300,function() {\n\t\t\t\t\tpiecesIndex++;\n\t\t\t\t\tif(piecesIndex==pieces.length)\n\t\t\t\t\t\taGame.MoveShown();\n\t\t\t\t\telse\n\t\t\t\t\t\tAnimate();\n\t\t\t\t});\n\t\t\t}\n\t\t\tAnimate();\n\t\t}\n\t\tfunction AnimateMana() {\n\t\t\tif(aGame.mOldBoard.mana==$this.mana) {\n\t\t\t\taGame.MoveShown();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif(aGame.mOldBoard.mana<0){\n\t\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tx: -7000,\n\t\t\t\t\t\ty: 0,\n\t\t\t\t\t\tvisible: true,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t\t\n\t\t\tvar coord=$this.getVCoord(aGame,$this.mana,$this.orient)\n\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: true,\n\t\t\t\t},\n\t\t\t\t\"3d\":{\n\t\t\t\t\tz: 1000,\n\t\t\t\t}\n\t\t\t},200,function(){\n\t\t\t\tMoveSound(aGame,'mana');\n\t\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t},\n\t\t\t\t},400,function() {\n\t\t\t\t\txdv.updateGadget(\"mana\",{\n\t\t\t\t\t\t\"3d\": {\n\t\t\t\t\t\t\tz: 0,\n\t\t\t\t\t\t},\n\t\t\t\t\t},200,function(){\n\t\t\t\t\t\taGame.MoveShown();\t\t\t\t\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\tfunction AnimateCapture(piece) {\n\t\t\tif (piece.t==\"d\"){\n\t\t\t\taGame.PlaySound('deathdamyo');\n\t\t\t}else{\n\t\t\t\taGame.PlaySound('sabers');\n\t\t\t\taGame.PlaySound('death'+Math.ceil(Math.random()*3));\n\t\t\t}\n\t\t\tvar coord=$this.pieceOutPosition(aGame,piece);\n\t\t\txdv.updateGadget((piece.t==\"d\"?\"damyo#\":\"ronin#\")+piece.s+\"#\"+piece.i,{\n\t\t\t\tbase: {\n\t\t\t\t\tx: coord[0],\n\t\t\t\t\ty: coord[1],\n\t\t\t\t\tvisible: true,\n\t\t\t\t},\n\t\t\t},400,function() {\n\t\t\t\tAnimateMana();\n\t\t\t});\n\t\t}\n\t\tif(aMove.o)\n\t\t\txdv.updateGadget(\"board\",{\n\t\t\t\t\"2d\": {\n\t\t\t\t\trotate: aGame.g.Orients[aMove.o].angle,\n\t\t\t\t\twidth: VSIZE*aGame.mOptions.width/.75,\n\t\t\t\t\theight: VSIZE*aGame.mOptions.height/.75,\n\t\t\t\t},\n\t\t\t\t\"orange3d\": {\n\t\t\t\t\trotate: -aGame.g.Orients[aMove.o].angle+90,\n\t\t\t\t},\n\t\t\t},1000,function() {\n\t\t\t\tPlacePieces();\n\t\t\t});\n\t\telse if(aMove.p)\n\t\t\tPlacePieces();\n\t\telse if(aMove.m) {\n\t\t\tvar movables=aGame.mOldBoard.manaMovablePieces(aGame);\n\t\t\tvar duration=400;\n\t\t\tvar pieceIndex=aGame.mOldBoard.board[aMove.m[0]];\n\t\t\tvar piece=aGame.mOldBoard.pieces[pieceIndex];\n\t\t\tvar pieceId=(piece.t==\"d\"?\"damyo\":\"ronin\")+\"#\"+this.mWho+\"#\"+piece.i;\n\t\t\tvar animPath=movables[pieceIndex][aMove.m[1]];\n\t\t\tvar animIndex=1;\n\t\t\tfunction AnimateSegment() {\n\t\t\t\tMoveSound(aGame);\n\t\t\t\tvar coord=$this.getVCoord(aGame,animPath[animIndex],$this.orient);\n\t\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\t\tbase: {\n\t\t\t\t\t\tx: coord[0],\n\t\t\t\t\t\ty: coord[1],\n\t\t\t\t\t},\n\t\t\t\t\t\"2d\":{\n\t\t\t\t\t\tz: 8,\n\t\t\t\t\t},\n\t\t\t\t\t\"orange3d\":{\n\t\t\t\t\t\t// z?\n\t\t\t\t\t},\n\t\t\t\t},duration,function() {\n\t\t\t\t\tanimIndex++;\n\t\t\t\t\tif(animIndex==animPath.length) {\n\t\t\t\t\t\tif(aGame.mOldBoard.board[aMove.m[1]]>=0)\n\t\t\t\t\t\t\tAnimateCapture(aGame.mOldBoard.pieces[aGame.mOldBoard.board[aMove.m[1]]]);\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tAnimateMana();\n\t\t\t\t\t} else\n\t\t\t\t\t\tAnimateSegment();\n\t\t\t\t});\n\t\t\t}\n\t\t\tAnimateSegment();\n\t\t} else if(aMove.i!==undefined) {\n\t\t\tvar piece;\n\t\t\tfor(var i=0;i<aGame.mOldBoard.pieces.length;i++) {\n\t\t\t\tpiece=aGame.mOldBoard.pieces[i];\n\t\t\t\tif(piece.t==\"r\" && piece.s==this.mWho && piece.p<0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tvar pieceId=\"ronin#\"+piece.s+\"#\"+piece.i;\n\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: true,\n\t\t\t\t},\n\t\t\t});\n\t\t\tvar coord=this.getVCoord(aGame,aMove.i,this.orient);\n\t\t\txdv.updateGadget(pieceId,{\n\t\t\t\tbase: {\n\t\t\t\t\tvisible: true,\n\t\t\t\t\tx: coord[0],\n\t\t\t\t\ty: coord[1],\n\t\t\t\t},\n\t\t\t},400,function() {\n\t\t\t\tAnimateMana();\n\t\t\t});\t\t\t\n\t\t}\n\t\treturn false;\n\t}\n\t\n})();\n\n"],"file":"mana-view.js"}